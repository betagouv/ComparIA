# Overlay for full stack (frontend + backend)
# Usage: docker compose -f docker-compose.yml -f app.compose.override.yml up
services:
  frontend:
    build:
      context: ../frontend
      dockerfile: ../docker/Dockerfile.front
      # command: ["node", "build"] # CMD du dockerfile frontend
    depends_on:
      - backend
    environment:
      PORT: "80"
      # URL for server-side rendering (inside Docker network)
      PUBLIC_API_LOCAL_URL: "http://backend:80"
      # URL for client-side browser requests (exposed to host)
      PUBLIC_API_URL: "http://localhost:5173"
    ports:
      - "5173:80"

  backend:
    env_file: ../.env
    environment: #
      LOGDIR: /data
      # LANGUIA_CONTROLLER_URL: "http://languia-controller:21001"
      COMPARIA_DB_URI: "postgresql://postgres:postgres@postgres:5432/languia"
      COMPARIA_REDIS_HOST: redis
    build:
      context: ..
      dockerfile: docker/Dockerfile
      # args:
      #   GIT_COMMIT: ${GIT_COMMIT:-}
      #   PUBLIC_API_URL: ${PUBLIC_API_URL:-}
      #   MATOMO_ID: ${MATOMO_ID:-}
      #   MATOMO_URL: ${MATOMO_URL:-}
    image: languia:latest
    ports:
      - "8001:80"
    # volumes: # en docker l'app est cens√©e etre stateless
    #   - ../data:/data
    command:
      [
        "uv",
        "run",
        "uvicorn",
        "main:app",
        "--host",
        "0.0.0.0",
        "--port",
        "80",
        "--timeout-graceful-shutdown",
        "60",
      ]
    depends_on:
      - postgres
      - redis
