# Overlay for full stack (frontend + backend)
# Usage: docker compose -f docker-compose.yml -f app.compose.override.yml up
services:
  frontend:
    build:
      context: ../frontend
      dockerfile: ../docker/Dockerfile.front
      args:
        # URL for client-side browser requests (compiled at build time)
        PUBLIC_API_URL: "http://localhost:8001"
    depends_on:
      - backend
    environment:
      PORT: "80"
      # URL for server-side rendering (inside Docker network)
      PUBLIC_API_LOCAL_URL: "http://backend:80"
      # URL for client-side browser requests (runtime)
      PUBLIC_API_URL: "http://localhost:8001"
    ports:
      - "5173:80"

  backend:
    env_file: ../.env
    environment:
      LOGDIR: /data
      # LANGUIA_CONTROLLER_URL: "http://languia-controller:21001"
      COMPARIA_DB_URI: "postgresql://postgres:postgres@postgres:5432/languia"
      COMPARIA_REDIS_HOST: redis
      GOOGLE_APPLICATION_CREDENTIALS: /app/google_creds.json
    build:
      context: ..
      dockerfile: docker/Dockerfile
    ports:
      - "8001:80"
    volumes:
      - ../google_creds.json:/app/google_creds.json:ro
    command:
      [
        "uv",
        "run",
        "uvicorn",
        "backend.main:app",
        "--host",
        "0.0.0.0",
        "--port",
        "80",
        "--timeout-graceful-shutdown",
        "60",
      ]
    depends_on:
      - postgres
      - redis
