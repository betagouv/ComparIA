FROM public.ecr.aws/docker/library/node:24.4

# Create a non-root user with the same UID/GID as the host user
ARG USER_ID=1000
ARG GROUP_ID=1000
RUN groupadd -g ${GROUP_ID} app && \
    useradd -m -u ${USER_ID} -g app app

ARG GIT_COMMIT
ENV PUBLIC_GIT_COMMIT=$GIT_COMMIT

ARG PUBLIC_API_URL
ENV PUBLIC_API_URL=$PUBLIC_API_URL

ARG MATOMO_ID
ENV MATOMO_ID=$MATOMO_ID
ARG MATOMO_URL
ENV MATOMO_URL=$MATOMO_URL

WORKDIR /app

# Install vite globally as root
RUN npm install -g vite

# Switch to app user for the rest
USER app

COPY --chown=app:app ./package.json ./yarn.lock /app
RUN yarn install
COPY --chown=app:app ./ /app

RUN vite build

EXPOSE 80
CMD ["node", "build"]
