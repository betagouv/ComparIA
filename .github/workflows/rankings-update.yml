name: Update Rankings

on:
  schedule:
    - cron: "0 7 * * 3"  # Run weekly on Wednesday at 7 AM UTC (1 hour after pipeline)
  workflow_dispatch:  # Allow manual triggering

permissions:
  contents: write
  pull-requests: write

jobs:
  update-rankings:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
          cache: 'pip'

      - name: Cache Python virtual environment
        uses: actions/cache@v4
        with:
          path: .venv
          key: ${{ runner.os }}-venv-rankings-${{ hashFiles('pyproject.toml', 'uv.lock') }}
          restore-keys: |
            ${{ runner.os }}-venv-rankings-

      - name: Setup Python virtual environment
        run: |
          python -m venv .venv
          source .venv/bin/activate
          pip install --upgrade pip

      - name: Install dependencies
        run: |
          source .venv/bin/activate
          pip install .

      - name: Run build_models script
        run: |
          source .venv/bin/activate
          python -m utils.models.build_models

      - name: Check for changes
        id: changes
        run: |
          # Check if any files were modified
          if git diff --quiet HEAD -- utils/models/generated-models.json utils/models/generated-models-extra-data.json frontend/locales/messages/fr.json frontend/src/lib/generated/models.ts; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes detected in generated files"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected in generated files"
            # Show what changed
            git diff --name-only HEAD
          fi

      - name: Create Pull Request
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Create and switch to rankings-update branch
          git checkout -b rankings-update
          
          # Add all generated files
          git add utils/models/generated-models.json
          git add utils/models/generated-models-extra-data.json
          git add frontend/locales/messages/fr.json
          git add frontend/src/lib/generated/models.ts
          
          # Commit changes
          git commit -m "Update rankings data from build_models script
          
          - Updated generated-models.json with latest model data
          - Updated frontend translations and TypeScript definitions
          - Auto-generated from utils.models.build_models"
          
          # Push to remote
          git push origin rankings-update --force
          
          # Create or update PR
          PR_BODY=$(cat <<'EOF'
          ## Summary
          Automated pull request with updated rankings data from the build_models script.
          
          ### Changes:
          - Updated `utils/models/generated-models.json` with latest model rankings and preferences
          - Updated `utils/models/generated-models-extra-data.json` with latest model extra data
          - Updated `frontend/locales/messages/fr.json` with new model descriptions and license information
          - Updated `frontend/src/lib/generated/models.ts` with TypeScript constants
          
          This PR is automatically generated when the `python -m utils.models.build_models` script
          produces changes to the generated model data.
          
          ---
          ðŸ¤– Generated by GitHub Actions
          EOF
          )
          
          # Check if PR already exists
          PR_COUNT=$(gh pr list --head rankings-update --json number | jq '. | length')
          if [ "$PR_COUNT" -gt 0 ]; then
            # Update existing PR
            PR_NUMBER=$(gh pr list --head rankings-update --json number | jq -r '.[0].number')
            gh pr edit "$PR_NUMBER" --body "$PR_BODY"
            echo "Updated existing PR #$PR_NUMBER"
          else
            # Create new PR
            gh pr create \
              --title "Update rankings data - $(date +%Y-%m-%d)" \
              --body "$PR_BODY" \
              --head rankings-update \
              --base main
            echo "Created new PR"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        run: |
          if [ "${{ steps.changes.outputs.has_changes }}" == "true" ]; then
            echo "âœ… Rankings data updated successfully"
            echo "ðŸ“ Pull request created/updated for branch: rankings-update"
          else
            echo "â„¹ï¸ No changes to rankings data"
          fi