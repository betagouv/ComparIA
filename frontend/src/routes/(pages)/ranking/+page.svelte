<script lang="ts">
  import { Tabs } from '$components/dsfr'
  import SeoHead from '$components/SEOHead.svelte'
  import { APINegativeReactions, APIPositiveReactions } from '$lib/chatService.svelte'
  import { m } from '$lib/i18n/messages'
  import { getModelsWithDataContext } from '$lib/models'
  import { externalLinkProps, sanitize } from '$lib/utils/commons'
  import { downloadTextFile, sortIfDefined } from '$lib/utils/data'
  import { Energy, Methodology, Preferences, RankingTable } from './components'

  const tabs = (
    [
      { id: 'ranking', icon: 'trophy-line' },
      { id: 'energy', icon: 'flashlight-line' },
      { id: 'preferences', icon: 'thumb-up-line' },
      { id: 'methodo' }
    ] as const
  ).map((tab) => ({
    ...tab,
    label: m[`ranking.${tab.id}.tabLabel`]()
  }))

  const modelsData = getModelsWithDataContext()

  function onDownloadData(kind: 'ranking' | 'energy') {
    const csvCols = [
      { key: 'rank' as const, label: 'Rank' },
      { key: 'id' as const, label: 'id', energy: true },
      { key: 'elo' as const, label: 'Bradley-Terry Score', energy: true },
      { key: 'trust_range' as const, label: 'Confidence interval' },
      { key: 'n_match' as const, label: 'Total votes' },
      { key: 'consumption_wh' as const, label: 'Consumption Wh (1000 tokens)', energy: true },
      { key: 'friendly_size' as const, label: 'Size', energy: true },
      { key: 'params' as const, label: 'Parameters (B)', energy: true },
      { key: 'arch' as const, label: 'Architecture', energy: true },
      { key: 'release_date' as const, label: 'Release' },
      { key: 'organisation' as const, label: 'Organisation', energy: true },
      { key: 'distribution' as const, label: 'Distribution', energy: true }
    ]
    const cols = kind === 'ranking' ? csvCols : csvCols.filter((col) => col.energy)
    const data = [
      cols.map((col) => col.label).join(','),
      ...modelsData
        .sort((a, b) => sortIfDefined(a.data, b.data, 'elo'))
        .map((m, i) => {
          return cols
            .map((col) => {
              if (col.key === 'elo' || col.key === 'rank' || col.key === 'n_match')
                return m.data[col.key]
              if (col.key === 'params') return m.license === 'proprietary' ? 'N/A' : m.params
              if (col.key === 'trust_range')
                return `+${m.data.trust_range![0]}/-${m.data.trust_range![1]}`
              return m[col.key]
            })
            .join(',')
        })
    ].join('\n')

    // FIXME add date
    downloadTextFile(data, `comparia_model-${kind}`)
  }

  function onDownloadPrefsData() {
    const csvCols = [
      { key: 'id' as const, label: 'id' },
      { key: 'positive_prefs_ratio' as const, label: 'positive ratio' },
      { key: 'total_prefs' as const, label: 'total prefs' },
      { key: 'total_positive_prefs' as const, label: 'total positive' },
      { key: 'total_negative_prefs' as const, label: 'total negative' },
      ...[...APIPositiveReactions, ...APINegativeReactions].map((reaction) => ({
        key: reaction,
        label: reaction.replaceAll('_', ' ')
      }))
    ]

    const data = [
      csvCols.map((col) => col.label).join(','),
      ...modelsData
        .sort((a, b) => sortIfDefined(a.prefs, b.prefs, 'positive_prefs_ratio'))
        .map((m) => {
          return csvCols
            .map((col) => {
              if (col.key === 'id') {
                return m[col.key]
              } else if (col.key === 'total_positive_prefs') {
                return APIPositiveReactions.reduce((acc, v) => acc + m.prefs[v], 0)
              } else if (col.key === 'total_negative_prefs') {
                return APINegativeReactions.reduce((acc, v) => acc + m.prefs[v], 0)
              } else {
                return m.prefs[col.key]
              }
            })
            .join(',')
        })
    ].join('\n')

    // FIXME add date
    downloadTextFile(data, `comparia_model-preferences`)
  }
</script>

<SeoHead title={m['seo.titles.ranking']()} />

<main class="pb-30 bg-light-grey pt-12">
  <div class="fr-container">
    <h1 class="fr-h3 mb-8!">{m['ranking.title']()}</h1>

    <Tabs {tabs} noBorders kind="nav">
      {#snippet tab({ id })}
        {#if id === 'ranking'}
          <p class="text-[14px]! text-dark-grey mb-12!">
            {@html sanitize(
              m['ranking.ranking.desc']({
                linkProps: externalLinkProps('https://www.peren.gouv.fr/')
              })
            )}
          </p>

          <RankingTable
            id="ranking-table"
            data={modelsData}
            onDownloadData={() => onDownloadData('ranking')}
          />
        {:else if id === 'energy'}
          <Energy data={modelsData} onDownloadData={() => onDownloadData('energy')} />
        {:else if id === 'preferences'}
          <Preferences data={modelsData} onDownloadData={() => onDownloadPrefsData()} />
        {:else if id === 'methodo'}
          <Methodology data={modelsData} />
        {/if}
      {/snippet}
    </Tabs>
  </div>
</main>
